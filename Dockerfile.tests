FROM mcr.microsoft.com/dotnet/sdk:8.0

WORKDIR /app

# Copy solution file
COPY RestaurantMenuAPI.sln ./

# Copy project files and restore dependencies
COPY src/RestaurantMenuAPI/RestaurantMenuAPI.csproj ./src/RestaurantMenuAPI/
COPY tests/RestaurantMenuAPI.Tests/RestaurantMenuAPI.Tests.csproj ./tests/RestaurantMenuAPI.Tests/

RUN dotnet restore

# Copy the rest of the source code
COPY src/ ./src/
COPY tests/ ./tests/

# Build the projects in Release configuration
RUN dotnet build --configuration Release --no-restore

# Create a directory for test results
RUN mkdir -p /app/TestResults

# Keep the container alive for exec commands if requested
ARG KEEP_ALIVE=false
ENV KEEP_ALIVE=$KEEP_ALIVE

# Entrypoint script
COPY docker-test-entrypoint.sh /app/docker-test-entrypoint.sh
RUN chmod +x /app/docker-test-entrypoint.sh

ENTRYPOINT ["/app/docker-test-entrypoint.sh"]