name: Test, Build, Push, and Deploy to GKE

on:
  push:
    branches: [ master ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  test-build-deploy:
    runs-on: ubuntu-latest
    env:
      GKE_ZONE: ${{ secrets.GKE_ZONE }}
      REGISTRY_REGION: ${{ secrets.REGISTRY_REGION }}
      REGISTRY: ${{ secrets.REGISTRY_REGION }}-docker.pkg.dev
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REPOSITORY: restaurant-repo
      IMAGE: restaurantmenuapi
      CLUSTER_NAME: restaurant-cluster

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run tests using Docker
      env:
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        MSSQL_SA_PASSWORD: ${{ secrets.MSSQL_SA_PASSWORD }}
      run: |
        chmod +x ./run-tests.sh
        ./run-tests.sh

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Enable required APIs
      run: |
        gcloud services enable artifactregistry.googleapis.com
        gcloud services enable container.googleapis.com

    - name: Create Artifact Registry repository
      run: |
        gcloud artifacts repositories create $REPOSITORY \
          --repository-format=docker \
          --location=$REGISTRY_REGION \
          --description="Restaurant Menu API Docker repository" || true

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker $REGISTRY

    - name: Build Docker image
      run: |
        docker build -f Dockerfiles/Dockerfile.backend -t $REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE:${{ github.sha }} .

    - name: Push Docker image
      run: |
        docker push $REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE:${{ github.sha }}

    - name: Create GKE cluster if not exists
      run: |
        if ! gcloud container clusters describe $CLUSTER_NAME --zone $GKE_ZONE; then
          gcloud container clusters create $CLUSTER_NAME --zone $GKE_ZONE --num-nodes=3
        fi

    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials $CLUSTER_NAME --zone $GKE_ZONE

    - name: Install GKE auth plugin
      run: |
        gcloud components install gke-gcloud-auth-plugin --quiet

    - name: Set up Helm
      uses: azure/setup-helm@v4

    - name: Deploy with Helm
      run: |
        helm upgrade --install restaurantmenuapi ./helm/restaurantmenuapi \
          --set image.repository=$REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE \
          --set image.tag=${{ github.sha }}

    - name: Debug deployment status
      run: |
        echo "ðŸ” Checking deployment status..."
        kubectl get deployments
        kubectl get pods -l app.kubernetes.io/name=restaurantmenuapi
        kubectl describe deployment restaurantmenuapi
        echo ""
        echo "ðŸ” Checking pod details..."
        kubectl describe pods -l app.kubernetes.io/name=restaurantmenuapi
        echo ""
        echo "ðŸ” Checking pod logs..."
        kubectl logs -l app.kubernetes.io/name=restaurantmenuapi --tail=50 || echo "No logs available yet"

    - name: Wait for deployment to be ready
      run: |
        echo "â³ Waiting for deployment to be ready (extended timeout)..."
        kubectl wait --for=condition=available --timeout=600s deployment/restaurantmenuapi
        echo "âœ… Deployment is ready!"

    - name: Wait for LoadBalancer IP
      run: |
        echo "â³ Waiting for LoadBalancer to get external IP..."
        for i in {1..30}; do
          EXTERNAL_IP=$(kubectl get service restaurantmenuapi -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          if [ ! -z "$EXTERNAL_IP" ]; then
            echo "âœ… External IP: $EXTERNAL_IP"
            echo "EXTERNAL_IP=$EXTERNAL_IP" >> $GITHUB_ENV
            break
          fi
          echo "â³ Still waiting for IP... (attempt $i/30)"
          sleep 10
        done
        if [ -z "$EXTERNAL_IP" ]; then
          echo "âŒ Failed to get external IP after 5 minutes"
          exit 1
        fi

    - name: Display access URLs
      run: |
        echo "ðŸŽ¯ Your Restaurant API is now live!"
        echo ""
        echo "ðŸ“‹ Swagger UI: http://$EXTERNAL_IP"
        echo "ðŸ”— Health Check: http://$EXTERNAL_IP/health"
        echo "ðŸ½ï¸ Menu API: http://$EXTERNAL_IP/api/menu"
        echo "ðŸ“… Reservations API: http://$EXTERNAL_IP/api/reservations"
        echo ""
        echo "ðŸŒ You can visit these URLs in your browser!"

    - name: Install load testing tool
      run: |
        echo "ðŸ“¦ Installing hey load testing tool..."
        wget -O hey https://hey-release.s3.us-east-2.amazonaws.com/hey_linux_amd64
        chmod +x hey
        sudo mv hey /usr/local/bin/

    - name: Check initial HPA and pod status
      run: |
        echo "ðŸ“Š Initial cluster status:"
        kubectl get hpa
        kubectl get pods -l app.kubernetes.io/name=restaurantmenuapi
        echo ""

    - name: Run load test and monitor HPA scaling
      run: |
        echo "ðŸ”¥ Starting load test against http://$EXTERNAL_IP"
        echo "Target: CPU > 40%, Memory > 50%"
        echo ""
        
        # Start load test in background
        hey -z 3m -c 20 -q 10 http://$EXTERNAL_IP/health &
        LOAD_TEST_PID=$!
        
        echo "ðŸ“Š Monitoring HPA scaling for 3 minutes..."
        for i in {1..18}; do
          echo "--- Check $i (every 10s) ---"
          kubectl get hpa restaurantmenuapi --no-headers | awk '{printf "HPA: %s/%s replicas, CPU: %s, Memory: %s\n", $7, $8, $3, $4}'
          kubectl get pods -l app.kubernetes.io/name=restaurantmenuapi --no-headers | wc -l | awk '{printf "Pod count: %s\n", $1}'
          echo ""
          sleep 10
        done
        
        # Wait for load test to complete
        wait $LOAD_TEST_PID
        echo "âœ… Load test completed!"

    - name: Monitor scale down behavior
      run: |
        echo "ðŸ“‰ Monitoring scale down (waiting 5 minutes)..."
        for i in {1..30}; do
          echo "--- Scale down check $i (every 10s) ---"
          kubectl get hpa restaurantmenuapi --no-headers | awk '{printf "HPA: %s/%s replicas, CPU: %s, Memory: %s\n", $7, $8, $3, $4}'
          kubectl get pods -l app.kubernetes.io/name=restaurantmenuapi --no-headers | wc -l | awk '{printf "Pod count: %s\n", $1}'
          echo ""
          sleep 10
        done

    - name: Final HPA test results
      run: |
        echo "ðŸŽ¯ Final HPA Test Results:"
        kubectl get hpa restaurantmenuapi
        kubectl get pods -l app.kubernetes.io/name=restaurantmenuapi
        kubectl describe hpa restaurantmenuapi
        echo ""
        echo "âœ… HPA load testing completed successfully!"
